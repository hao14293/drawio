# 感知服务详细设计文档

感知服务包含人、车、结构化、步态相关业务

<img src="%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20240717090237595.png" alt="image-20240717090237595" style="zoom: 200%;" />





| **业务类型**   | **主要功能**                                                 |
| -------------- | ------------------------------------------------------------ |
| 人脸智能业务   | 注册库管理、库成员管理、实时图片流分析、布控管理、以图搜图、1V1比对、NVN库碰撞比对 |
| 车辆智能业务   | 实时图片流分析、以图搜图                                     |
| 结构化智能业务 | 实时图片流分析、实时视频流分析、录像分析、预案任务分析、以图搜图 |
| 步态业务       | 注册库管理、库成员管理、实时视频流分析、实时图片流分析、录像分析、布控管理、以图搜图 |
| 事件业务       | 实时视频流分析、实时图片流分析、录像分析误报库管理           |



| **服务名称**             | **服务简介**                                                 | **Git****仓库名称**     | **技术栈** | **主要负责人**   |
| ------------------------ | ------------------------------------------------------------ | ----------------------- | ---------- | ---------------- |
| CVEngine-Business        | 网关服务：北向统一对各服务平台提供https服务，转发至内部其他业务服务模块 | **CVEngine-gateway**    | go         | 饶平             |
| CVEngine-Maintainer      | 配置中心：管理和分发视图智能集群中各服务的配置信息  注册中心：管理集群中各服务信息；集群各服务向注册中心注册本服务信息，订阅所依赖服务的信息 | **maintainer**          | java       | 赵晨时、曹敏     |
| CVEngine-ResourceManager | 资源管理模块：管理智能算力资源，包括硬件资源和智能算子资源   | **ResourceManager**     | java       | 赵晨时、曹敏     |
| CVEngine-MPlatform       | 中台（算法仓库）服务：管理算法包、算子包、算法、智能网络资源等信息 | **CVEngine-library**    | java       | 张广领、孟红全   |
| CVEngine-Perception      | 感知服务：对外提供人脸智能业务、车辆智能业务、结构化智能、步态智能业务服务 | **CVEngine-Perception** | java       | 赵晨时、曹敏     |
| CVEngine-Cognition       | 认知服务：对外提供事件智能业务服务、大模型智能业务服务       | **CVEngine-cognition**  | java       | 吴林俊、黄强     |
| CVEngine-Actuator        | 智能运维服务：面向技术支持快速排查问题，针对集群内各类日志、异常及数据关系做运维展示 | **CVEngine-Actuator**   | java       | 曹敏             |
| CVEngine-Executor        | 数据级联服务：分发流转各类智能相关数据，如将已开启分析的抓拍数据分发给具有对应智能分析能力的算子 | Executor                | go         | 饶平、建辉、广领 |
| CVEngine-Agent           | 调度子节点服务：收集硬件信息上报给资源管理服务；管理智能算子进程 | Agent                   | java       | 赵晨时           |
| CVEngine-Feature         | 特征存储服务：存储特征值及注册库图片；也可临时存储抓拍库图片 | pf                      | java       | 董雨轩、方彪     |
| CVEngine-Redis           | 目前存储了图搜结果信息、静态库分片信息及一些智能运维所需数据 |                         | 开源       | 万光宝           |
| 公共脚本                 | 安装部署、升级等功能的公共脚本                               | cvengine-tool           | shell      | 庄建辉           |



# 总体工程设计

![image-20240717090449871](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20240717090449871.png)



Deploy为启动模块

Common 模块为所有模块的公共依赖部分

DataBase模块为sql相关

Ha 模块为主备

Rpc模块为grpc相关

Core模块为人车结构化步态公共业务模块

其余功能模块分为api部分与Service 部分，便于后期拆解转换为dubbo



## Deploy模块

### 鉴权修改

感知服务不再实现鉴权功能，但是仍然需要获取ak sk uid等用户信息。 此功能改为通过business 网关服务获取。
  具体实现可参看AuthInfoAop，直接从网关转发的请求头中获取。

```
/**
 *  Perception的鉴权 没有用MaintainerClient 中的接口，所以配置中都为false
 *  自己在Aop中实现了新的鉴权逻辑,因为网关已经比较了认证信息了，这里没有必要再生成与比较一次
 *
 *  但是还是留一个后门配置，可以关闭鉴权，即允许请求不带ak sk uid信息
 */
```



```java
// AuthInfoAop.java
使用Spring AOP（Aspect Oriented Programming，面向切面编程）来实现一个权限验证的切面（Aspect）。

@Aspect // 标记此类为一个切面，用于横切关注点的模块化，如日志、事务、权限验证等。
@Order(value = 100) // 定义此切面的优先级，数值越小优先级越高。在有多个切面时，决定它们的执行顺序。
@Component // 将此类声明为Spring容器管理的组件，使得切面可以被自动识别和加载。
@Slf4j 
public class AuthInfoAop {

    @Autowired 
    private AuthInfoImpl authInfoImpl;
    @Autowired 
    private CommonProperties commonProperties;

    // 定义一个切点（Pointcut），指定此切面将作用于哪些方法上。
    @Pointcut("execution(* com.dahuatech.cvengine.perception.*.controller..*(..)) " + // 
            "&& !execution(* com.dahuatech.cvengine.perception.support.controller.RepositoryRedistributeController.*(..))") // 切点排除RepositoryRedistributeController下的所有方法。
    public void pointcut() { // 空方法，仅作为切点的标识。
    }

    @Around(value = "pointcut()") // 定义一个环绕通知（Around Advice），在匹配的方法调用前后执行。
    public Object around(ProceedingJoinPoint pjo) throws Throwable { // 声明around方法，参数pjo是一个代理点（ProceedingJoinPoint），代表即将被调用的方法。

        HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest(); // 从当前线程中获取HttpServletRequest对象，用于读取HTTP请求头信息。

        AuthInfo authInfo = new AuthInfo(); // 创建AuthInfo对象，用于存储权限验证所需的信息。

        String userId = request.getHeader("userId"); // 从请求头中获取用户ID。
        String userAk = request.getHeader("userAk"); // 从请求头中获取用户的Access Key ID。
        String userSk = request.getHeader("userSk"); // 从请求头中获取用户的Secret Access Key。

        // 网关关闭鉴权，会发送一个userId为-1的请求头。
        if(!StringUtils.isEmpty(userId) && userId.equals("-1")){ // 如果用户ID存在且等于"-1"，表示网关关闭了鉴权。
            authInfoImpl.notifyAuthInfo((AuthInfo) null); // 调用AuthInfoImpl的notifyAuthInfo方法，传入null表示无需权限验证。
            return pjo.proceed(); // 继续执行原方法。
        }

        if (StringUtils.isEmpty(userId) || StringUtils.isEmpty(userAk) || StringUtils.isEmpty(userSk)) { // 检查用户ID、Access Key ID和Secret Access Key是否为空。
            throw new AppException("vcsAuthError", "auth failed"); // 如果缺少任何一项，则抛出AppException，表示权限验证失败。
        }
        
        authInfo.setUserId(Integer.valueOf(userId)); // 设置AuthInfo对象的用户ID。
        authInfo.setAccessKeyId(userAk); // 设置AuthInfo对象的Access Key ID。
        authInfo.setSecretAccessKey(userSk); // 设置AuthInfo对象的Secret Access Key。
        
        authInfoImpl.notifyAuthInfo(authInfo); // 调用AuthInfoImpl的notifyAuthInfo方法，传入填充好的AuthInfo对象进行权限验证。
        
        return pjo.proceed(); // 权限验证通过后，继续执行原方法。
    }
}

//定义了一个权限验证的切面，它会在指定的控制器方法调用前检查HTTP请求头中的权限信息，如果验证通过则允许方法继续执行；如果验证失败或网关指示无需验证，则会相应地抛出异常或直接放行。
```

## DataBase 模块

Database模块现在由一种mapper生成工具统一生成，所有的sql写法也都做了统一处理。 以后如果要修改，新增表，务必使用相同的工具生成。此工具存放在此模块test目录下，已经配置好，稍加修改执行即可。

```md
MybatisGenerator 

也可以使用idea的MybatisX插件自动生成
```



# 一、库管理

为了将所有的成员分门别类存放，便于后续识别、查找、布控，提供库管理功能，包含创建、修改、删除、查询等操作。不同成员存在意义不同，有些成员可以用来布控告警，有些成员只需要检索， 因此将库分为不同类型，提供不同作用。库类型分为黑名单、白名单、静态库。

* **黑名单、白名单**：目前功能一致，提供检索及布控，告警算子、检索算子均需要加载所有黑名单、白名单

* **静态库**：提供检索功能，检索算子加载；由于一般静态库成员较多，亿级别以上，若均加载在一个检索算子，会急剧消耗该算子内存，且检索性能低下；因此，对于静态库成员特征会进行**分片存储**，**每个检索算子加载某些分片**，尽量均衡

**目前只有人脸、步态具有库管理功能，包含创建、修改、删除、查询操作**。

约束条件：

>  库名称以及REPOSITORY_RECORD_ID不允许重复（不包括待删除的）

> 存在布控、通道分析挂载的抓拍库、聚类库不允许删除



| **库类型** | **描述**                   |
| ---------- | -------------------------- |
| 0          | 黑名单（布控库）（注册库） |
| 1          | 白名单（布控库）（注册库） |
| 2          | 静态库（注册库）           |
| 3          | 抓拍库                     |
| 4          | 路人库or聚类库             |
| 5          | 全局新建档库               |
| 99         | 通用类                     |



## 1. 人像库业务功能

### Repository数据表

![repository](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/repository.png)

```java
// model
public class Repository extends BaseModel {
    /** 人像库ID */
    private Integer repositoryId;
    /** 人像库记录ID */
    private String repositoryRecordId;
    /** 库名称 */
    private String repositoryName;
    /** 库类型 */
    private Integer repositoryType;
    /** 备注 */
    private String memo;
    /** 创建时间 */
    private Long createtime;
    /** 更新时间 */
    private Long updatetime;
    /** 记录状态 */
    private Integer state;
    /** 版本号 */
    private Integer operationVersion;
    /** 用户ID */
    private Integer uid;
    /** 业务类型  1：face   2：车辆  4：结构化   8：缩略图 */
    private Integer businessType;
    /** 库生命周期 */
    private int lifeCycle;
}
```

<img src="%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20240717100231910.png" alt="image-20240717100231910" style="zoom:25%;" />

### 1.1. 创建人像库

```json
// 人脸PaaS中创建一个人像库，库类型分为黑名单、白名单以及静态库，其中黑名单及白名单可用来布控，静态库只用来检索。
POST  /processing/face/repository
{
    "name" : "xxxxx", // 人像库名字，库名字必须保持唯一
    "type": 2, // 0	黑名单 1	白名单; 2	静态库
    "recordId" : "xxxx", // 库的脱敏id，若为空，则PAAS层会自动生成唯一的脱敏id。选填项。
    "memo": "备注"
}

{
    "id" : "xxxxxxx" // 生成的人像库id。
}
```



####   1.1.1 时序图

![img](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/Tue,%2006%20Aug%202024%20141733.png)

#### 1.1.2 流程图

[创建人像库](C:\Users\485322\Downloads\创建人像库-流程图.pdf)

![创建人像库-流程图.drawio](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/%E5%88%9B%E5%BB%BA%E4%BA%BA%E5%83%8F%E5%BA%93-%E6%B5%81%E7%A8%8B%E5%9B%BE.drawio.png)



#### 1.1.3 实现逻辑描述

1. Saas请求 添加人像库，人像库只能添加 黑名单、白名单、静态库；name 不能为空且长度不超过128；memo 不超过128
2. 业务数据校验，库名称和recordId不能重复
3. 内存加载库id信息以及库资源（空）关系，无绑定动作。

* 人像库名称以及REPOSITORY_RECORD_ID不允许重复（不包括待删除的），重复则失败

* 只可以创建黑名单，白名单，静态库

* 内存加载库

* 静态库——检索算子加载

*  黑白名单库——告警算子、检索算子均加载



### 1.2 修改人像库

```json
// 根据创建时生成的人像库ID，对指定人像库修改；允许修改字段为库名称及描述。
PUT  /processing/face/repository/[repositoryId]
{
    "name" : "逃犯库", // 修改的库名称不能与已有的库名称重复。
    "memo" : ""
}
```



#### 1.2.1 时序图

![修改人像库——时序图](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/%E4%BF%AE%E6%94%B9%E4%BA%BA%E5%83%8F%E5%BA%93%E2%80%94%E2%80%94%E6%97%B6%E5%BA%8F%E5%9B%BE.png)

#### 1.2.2 流程图

![修改人像库-流程图.drawio](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/%E4%BF%AE%E6%94%B9%E4%BA%BA%E5%83%8F%E5%BA%93-%E6%B5%81%E7%A8%8B%E5%9B%BE.drawio.png)

#### 1.2.3 实现逻辑描述

1. SaaS平台下发修改任务，校验参数，name,memo长度不超过128 

2. 根据repositoryRecordId查询数据库表REPOSITORY记录，如果不存在，返回异常。

3. 判断是否为黑白名单库，且是否修改库名称。

   3.1 是  修改库名称，并请求Excutor同步路由

   3.2 否  修改库信息

4. 返回

### 1.3 删除人像库

```java
// 根据人像库ID，删除该人像库。
DELETE  /processing/face/repository/[repositoryId]
```



涉及到数据表 Repositor】和Repository_Resource以及ChannelAnalysis、surveillance、nvnJob

#### 1.3.1 时序图

![image-20240718085054316](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20240718085054316.png)

#### 1.3.2 关键路径流程图

[删除人像库](C:\Users\485322\Downloads\删除人像库-流程图.pdf)

![删除人像库-流程图.drawio](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/%E5%88%A0%E9%99%A4%E4%BA%BA%E5%83%8F%E5%BA%93-%E6%B5%81%E7%A8%8B%E5%9B%BE.drawio.png)

#### 1.3.3 实现逻辑描述

1. SaaS平台下发删除任务，校验参数RecordId不能为空。

2. 查询REPOSITORY表中记录是否存在RecordId是否存在。

3. 存在该人像库，则判断该人像库是否被 布控任务（SURVEILLANCE表）、通道分析（CHANNEL_ANALYSIS表）、NVN任务（NVN_JOB表）使用。

4. 如果人像库在使用，抛出异常，正在使用，不可删除，不再使用则更新REPOSITORY.STATE、REPOSITORY_RESOURCE. OPERATION_STATE状态-2

5. 删除内存缓存，库id信息缓存，库资源关系缓存。

6. 返回成功

7. 后台线程执行清理动作



### 1.4. 查询人像库



```java
// 根据人像库类型、名称分页查询人像库信息，支持库名称的模糊查询。有云库的场景下才可调用该接口，无云库场景下调用该接口则会报错。
GET  /processing/face/repository?args
	type 0	黑名单 1	白名单 2	静态库
    name:类型string。人像库名称，支持模糊查询，即支持前向匹配、后向匹配、中间匹配。可选项。
	key:类型string。人像库名称或者描述的模糊查询，支持前向匹配、后向匹配、中间匹配（人像大数据平台使用）；当name不为空时，以name为主。
	start:类型int。从第几个结果开始返回,最小值为1，不填默认为1。
	limit:类型int。返回至多多少结果，最大值为1024，不填默认为512。

GET  /processing/face/repository?start=1&limit=20&name=123&type=2&key=123 
HTTP/1.1 200
Header
{
    "totalCount" : 1,
    "results" : [{
        "id" : "12345678",
        "name" : "逃犯库",
        "type" : 0,
        "memo" : "xxxxxxx",
        "createTime" :1503709064010,
        "creator" : "system",
        "totalPictureCount" : 1000,
        "faceImageCount" : 900,
        "failedPictureCount" : 100
    }]
}
```

> 个人理解：Repository存的是各种类型库的信息（如静态库对应的id这些基本信息），但重要敏感的数据（如人脸图像）都是存到云端数据库，所以只查询Repository是无法获取这些敏感数据。查询的时候先查询Repository每个库的ID等信息，再用这些信息去查询云端数据库。查云数据库时，通过AK、SK组装HTTP请求来查询。
>
> 这个查询人像库的接口是获取每个库对应的记录数量。

#### 1.4.1 时序图

![image-20240718105301037](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20240718105301037.png)

#### 1.4.2 关键路径流程图

![image-20240718105336712](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20240718105336712.png)

#### 1.4.3 实现逻辑描述

1. SaaS平台下发查询请求，校验参数，分页参数校验；组装查询参数name/key模糊查询。

2. 判断库成员存储位置

   2.1 云库 查询云库个人像库ID对应成员人数。

   2.2  mysql 查询MEMBER, REPOSITORY 表统计人像库ID对应库成员人数。

3. 返回封结果





### 1.5. 查看单个人像库

```java
// 根据人像库ID查询对应人像库信息。
GET  /processing/face/repository/[repositoryId]?args
    repositoryId:类型string。人像库id。必填项。
    args为参数列表，以key=value的形式标识，多个参数之间使用&连接。
    showCounts:类型bool。是否返回库成员个数，选填项，默认为true。

GET  /processing/face/repository/123?showCounts=true
{
    "id" : "12345678",
    "name" : "逃犯库",
    "type" : 0,
    "memo" : "xxxxxxx",
    "createTime" :1503709064010,
    "creator" : "system",
    "totalPictureCount" : 1000,
    "faceImageCount" : 900,
    "failedPictureCount" : 100
}
```



#### 1.5.1 时序图

![image-20240718150218928](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20240718150218928.png)

#### 1.5.2 关键路径流程图

![image-20240718150504778](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20240718150504778.png)

#### 1.5.3 实现逻辑描述

1. SaaS平台下发查询请求，校验参数，

2. 根据REPOSITORY_RECORD_ID 查询库信息，如果不存在，抛出异常

3. 判断库成员存储位置、

   3.1云库 查询云库个人像库ID对应成员人数。

   3.2 mysql 查询MEMBER, REPOSITORY 表统计人像库ID对应库成员人数。

4. 返回结果



### 1.6. 查看库信息

```java
// 根据库类型、名称分页查询库信息，支持库名称的模糊查询。(注：车辆抓拍库不返回，只返回人脸相关的库)
GET  /processing/face/repositories?args
GET  /processing/face/repositories?start=1&limit=20&name=123&type=2&key=123
{
    "totalCount" : 1,
    "results" : [{
        "id" : "12345678",
        "name" : "逃犯库",
        "type" : 0,
        "memo" : "xxxxxxx",
        "createTime" :1503709064010,
        "creator" : "system"
    }]
}
```



#### 1.6.1 时序图

![image-20240718155309267](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20240718155309267.png)

#### 1.6.2 关键路径流程图

![image-20240718155412373](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20240718155412373.png)

#### 1.6.3 实现逻辑描述

1. SaaS平台查询请求，分页参数校验，type类型校验 0,1,2,3,4 或者为null; 转译name、key模糊查询.

2. 查询REPOSITORY对应库信息。（不返回库成员数量）

3. 返回封装结果



### 1.7. 批量查看库信息（只看0，1，2注册库）

```java
// 根据库ID列表，批量查询库信息，
POST  /processing/face/repository/queries
{
    "ids":["123456", "123456"],
    "type":0, // 库类型	0	黑名单 1	白名单 2	静态库
    "name":"",
    "key":"",
    "start":1,
    "limit":32
}

{
    "results" : [
    {
        "id" : "12345678",
        "name" : "逃犯库",
        "type" : 0,
        "memo" : "xxxxxxx",
        "createTime" :1503709064010,
        "creator" : "system"
    },
    {
        "id" : "12345678",
        "name" : "逃犯库",
        "type" : 0,
        "memo" : "xxxxxxx",
        "createTime" :1503709064010,
        "creator" : "system"
    }]
}
```



#### 1.7.1 时序图

![image-20240718161921668](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20240718161921668.png)

#### 1.7.2 关键路径流程图

![image-20240718161946272](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20240718161946272.png)

#### 1.7.3 实现逻辑描述

1. Saas下发批量查询库信息，分页参数校验。查询类型校验，

2. 根据是否存在recordId确定精确查询或模糊查询

3. 封装返回结果



### 1.8. 查看人像库图片信息 (只是查询012图片数量信息，和上面逻辑相同)

```java
// 根据库ID列表，批量查询库中图片信息
POST  /processing/face/repository/picture
{
    "ids":["123456", "123456"]
}
{
    "results" : [{
        "id" : "12345678",
        "totalPictureCount" : 1000
    },
    {
        "id" : "12345678",
        "totalPictureCount" : 1000 // 库中图片的数目。
    }]
}
```



#### 1.8.1 时序图

![image-20240718163430859](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20240718163430859.png)

#### 1.8.2  关键路径流程图

![image-20240718163459386](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20240718163459386.png)

#### 1.8.3 实现逻辑描述

1. SaaS平台请求查询人像库图片信息，参数校验，库id不能为空

2. 校验库id是否存在，不存在返回异常

3. 存在库id,判断是否开启云存，开启云存，则云库查询库图片信息

4. 未开启云存，则查询

5. 返回封装结果













### 库资源管理功能

####  绑定资源关系

* 首先获取业务处理类，不同的业务有不同的业务实现；
* 获取到业务处理类handles后，会执行`handle.addRepositoryResourceInfo(request)` 方法，该方法是库资源绑定的关键，具体的绑定细节都在该方法中执行；

#####  流程图

<img src="%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20240719101913464.png" alt="image-20240719101913464" style="zoom:150%;" />

#####  流程描述

1、 创建库，根据库类型创建对应的库或分片

2、 根据库类型查询需要绑定的算子资源

3、 将库绑定关系持久化到mysql repository_Resource

4、 写入内存Cache （Map）

注意点：

(1)  静态库可能只是添加一个库Id,并不会创建分片，这时候我们只把key保存在Map中，value是空. 这么做只是为了让DP动作统一，实际上保存这个没有其他作用。

(2)  查询资源的方式：

布控库：查询单个状态为(1,6) ，剩余能力最多的检索算子，(1,3,6)的所有告警算子。

静态库：查询单个状态为(1,6) ，剩余能力最多的检索算子。

抓拍库：查询单个状态为(1,3,6)的检索算子。

(3)  添加布控库，需要和所有的告警绑定

(4)  存在的问题：

只有一个告警算子也可以添加布控库成功，这样会导致不能选择这个库进行检索。



* `AbstractStub`类提供了基础的RPC调用逻辑，包括连接管理、序列化/反序列化、错误处理等。它还提供了方法来构建和配置客户端存根，比如设置Channel、CallOptions等。通过继承`AbstractStub`，子类可以专注于实现具体的RPC方法，而不需要关心底层的通信细节。
* `withDeadlineAfter`方法帮助你管理RPC调用的超时时间，这对于处理那些可能长时间运行或不可预测的服务响应非常重要。它确保了客户端不会无休止地等待，提高了应用程序的健壮性和用户体验。当RPC调用超时被取消时，gRPC框架会释放与该调用相关的资源，如网络连接和线程，避免资源泄露。超时后，gRPC会抛出一个`Status.DEADLINE_EXCEEDED`异常，这可以帮助你识别哪些服务调用可能存在问题，比如性能瓶颈或服务不可用。



<img src="%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/clip_image002.png" alt="img" style="zoom:150%;" />



## 二、库成员管理

###  功能描述

为了查询检索，将成员记录导入库中，同时提取每个成员的特征记录，便于后续的特征比对计算相似性进行检索。功能包含：

1. 添加：库成员图片存入Feature固态存储，对于后端智能——将图片发往分析算子提取特征，特征写入Feature固态存储，同时特征实时添加进检索、告警算子，最后记录写入mysql或发往云数据库的MQ进行固态存储；

2. 删除：由于成员图片业务层还需要用到，如历史告警原图展示，因此删除成员时，不进行图片删除，只删除成员记录（mysql或者CloudDB）及算子内存加载、Feature固态存储的特征

3. 修改：修改mysql、CloudDB或者前端智能上的记录数据 

4. 查询：根据查询条件从mysql或者CloudDB中查询成员记录数据

约束条件：recordId必须唯一



### 1. 新增库成员

```java
// 向指定人像库中添加一个库成员，图片可来自于url，也可使用base64编码后的图片内容。也可使用特征值添加库成员。
POST  /processing/face/repository/member
{
    "repositoryId" : "12345678", 
    "idType" : 1,
    "identificationId" : "432524198710140065",
    "recordId" : "234890345348534",
    "name" : "小王",  
    "englishName" : "xiaowang",
    "nationalityCode" : "12",
    "validityStart" : "2018-04-13",
    "validityEnd" : "2028-04-13",
    "region" : 12222,
    "nation" :   1,
    "birthday" : "1985-10-17",
    "gender" : 1,
    "province" : "xx",
    "city" : "xx",
    "tel" : "xxxx",
    "address" : "xx",
    "memo" : "xxx",
    "ext1" : "xx",
    "ext2" : "xxx",
    "ext3" : "xxx",
    "facePicture" : {
        "type" : 1,
        "data" : "",
        "url" : "http://1.jpg"
    },
    "feature" : "xxx",
    "algorithmVersion": "1001001002003",
    "syncToCloudDB":true, //同步库成员信息到云数据库，默认值为true，表示同步添加库成员信息到云数据库。
    "syncToCluster":false  //是否将库成员信息同步到智能计算一体机聚类业务的数据库中，默认为false，表示不将库成员同步到智能计算一体机聚类业务的数据库。
}
响应
{
     "id" : "xxxxxxx"
}
```



#### 1.1 时序图

<img src="%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20240723091403455.png" alt="image-20240723091403455"  />



#### 1.2 流程图

[新增库成员](C:\Users\485322\Documents\库管理\Visio图\新增库成员——流程图.pdf)

<img src="%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/%E6%96%B0%E5%A2%9E%E5%BA%93%E6%88%90%E5%91%98%E2%80%94%E2%80%94%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="新增库成员——流程图" style="zoom: 200%;" />

![image-20240723091425574](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20240723091425574.png)

##### 库信息补全和参数转换

![image-20240723091540003](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20240723091540003.png)

##### 特征添加和广播

![image-20240723091642016](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20240723091642016.png)

##### 库成员持久化

**库成员成功计数**

![image-20240723091707111](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20240723091707111.png)

#### 1.3 流程描述

1    接收到Saas服务下发添加库成员请求。

2    **服务状态检查**：检测mysql以及mq状态，如异常返回异常

**3**    **参数校验**

4    **参数转换**：将下发参数repositoryId（对应数据库REPOSITORY. REPOSITORY_RECORD_ID）转换成内部使用的repositoryId（对应数据库REPOSITORY. REPOSITORY_ID）

5    **图片转存**：如果是图片添加库成员，在开启静态库智能存储的条件下，将图片url给到feature转存

6    **库信息补全**：静态库添加库成员，需要获取静态库分片。如果分片不存在，或已存在分片都大于等于阈值，则需要创建新的静态库分片，并绑定库资源关系；如果分片存在且小于分片阈值，选取剩余容量最小分片。

7    **特征提取：**如果使用特征添加库成员，则向Feature存储特征；如果使用图片添加库成员，则向分析算子提取特征，（如需存储特征）向Feature存储特征。

8    **特征存储：**向Feature请求添加特征，失败记录相应错误码和错误信息，成功则向算子广播库成员特征。

9    **特征广播：**将提取的特征通过rpc请求广播给算子，成功则持久化库成员，失败则写入Mysql FEATURE_TO_BROADCAST、FEATURE_TO_RESOURCE表，交由后台线程处理。

10   **库成员持久化：**

**10.1** **本地mysql持久化：**将库成员写入member表，完成

**10.2** **云库持久化：**将库成员通过mq消息或者使用云库http接口保存库成员信息。

11   **返回添加结果。**



**异常点处理**及影响：

l 基础环境检查

MQ及MYSQL任一异常，则直接返回导库失败，强依赖

l 异常点一：算子实时特征存储失败

处理方式：写表，每天凌晨执行，记录url走重提

l 异常点二：CloudDB存储失败

处理方式：返回失败，单独写失败日志，该日志不设置生命周期

影响：

a)   算子内存空间占用

b)  检索：以图搜图算子有返回，若设置face.is.return.op.result=false，补齐时云数据库无法查询则不对外展示，则对结果无影响；若设置face.is.return.op.result=true，则会返回无结构化数据的记录；该配置默认为true；

c)   查询：无影响

d)  告警：无影响，Executor信息补全失败则不告警

l 异常点三：mysql存储失败

处理方式：同异常点二

影响：同异常点二



### 2. 批量新增库成员

```java
// 向指定人像库中添加单个或多个库成员，可添加图片，也可直接添加特征进行入库。该接口只支持后端智能服务导入，不支持前端智能（例如：ivss）批量库成员导入。
POST  /processing/face/repository/batch/member
{
    "saveFeature" : true,
    "returnFeature" : true, 
    "records":[{
        "repositoryId" : "12345678",
        "idType" : 1,
        "identificationId" : "432524198710140065",
        "name" : "小王",  
        "englishName" : "xiaowang",
        "nationalityCode" : "12",
        "validityStart" : "2018-04-13",
        "validityEnd" : "2028-04-13",
        "region" : 12222,
        "nation" :   1,
        "birthday" : "1985-10-17",
        "gender" : 1,
        "province" : "xx",
        "city" : "xx",
        "tel" : "xxxx",
        "address" : "xx",
        "memo" : "xxx",
        "ext1" : "xx",
        "ext2" : "xxx",
        "ext3" : "xxx",
        "faceInfo" : {
            "recordId" : "234890345348534",
            "type" : 1,
            "feature" : "xxx",
            "algorithmVersion": "1001001002003"，
            "url" : "http://1.jpg"
        }
    }]，
    "syncToCloudDB":true，
    "syncToCluster":false
}

HTTP/1.1 200
{
    "records":[{
        "repositoryId" : "12345678",
        "faceInfo" : {
            "recordId" : "234890345348534"
        },
        "isSuccess":true,
        "code":"xxxx",
        "message":"xxxx"
    }]
}
```

#### 2.1 时序图

<img src="%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20240806144936320.png" alt="image-20240806144936320" style="zoom:110%;" />



#### 2.2 流程图

[批量新增库成员](C:\Users\485322\Documents\库管理\Visio图\批量新增库成员——流程图.pdf)

![批量新增库成员——流程图](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/%E6%89%B9%E9%87%8F%E6%96%B0%E5%A2%9E%E5%BA%93%E6%88%90%E5%91%98%E2%80%94%E2%80%94%E6%B5%81%E7%A8%8B%E5%9B%BE.png)



#### 2.3 流程描述

1. 接收到Saas服务下发批量新增库成员请求。

2.  **服务状态检查**：检测mysql以及mq状态，如异常返回异常

3. **参数校验**

4. **参数转换**：将下发参数repositoryId（对应数据库REPOSITORY. REPOSITORY_RECORD_ID）转换成内部使用的repositoryId（对应数据库REPOSITORY. REPOSITORY_ID）

5. **图片转存**：如果是图片添加库成员，在开启静态库智能存储的条件下，将图片url给到feature转存

6.  **库信息补全**：静态库添加库成员，需要获取静态库分片。如果分片不存在，或已存在分片都大于等于阈值，则需要创建新的静态库分片，并绑定库资源关系；如果分片存在且小于分片阈值，选取剩余容量最小分片。

7. **特征提取：**如果使用特征添加库成员，则向Feature存储特征；如果使用图片添加库成员，则向分析算子提取特征，（如需存储特征）向Feature存储特征。

8. **特征存储：**向Feature请求添加特征，失败记录相应错误码和错误信息，成功则向算子广播库成员特征。

9. **特征广播：**将提取的特征通过rpc请求广播给算子，成功则持久化库成员，失败则写入Mysql FEATURE_TO_BROADCAST、FEATURE_TO_RESOURCE表，交由后台线程处理。

10.  **库成员持久化：**

    *10.1** **本地mysql持久化：**将库成员写入member表，完成

    **10.2** **云库持久化：**将库成员通过mq消息或者使用云库http接口保存库成员信息。

11. **返回添加结果。**



### 3. 修改库成员

```java
// 根据库成员ID，修改该成员的身份标识、身份类型、姓名、区域编号、民族、出生日期、性别等信息。
PUT  /processing/face/repository/member/[memberId] HTTP/1.1
{
    "identificationId" : "432524198710140065",
    "idType" : 111,
    "name" : "小王",   
    "englishName" : "xiaowang",
    "nationalityCode" : "12",
    "validityStart" : "2018-04-13",
    "validityEnd" : "2028-04-13",
    "region" : 12222,
    "nation" :   1,
    "birthday" : "1985-10-17",
    "gender" : 1,
    "province" : "xx",
    "city" : "xx",
    "tel" : "xxxx",
    "address" : "xx",
    "memo" : "xxx",
    "ext1" : "xx",
    "ext2" : "xxx",
    "ext3" : "xxx",
    "syncToCloudDB":true,
    "syncToCluster":false
}
HTTP/1.1 200
```



#### 3.1 时序图

![image-20240806145406164](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20240806145406164.png)



#### 3.2 流程图

[修改库成员.pdf](C:\Users\485322\Documents\库管理\Visio图\修改库成员——流程图.pdf)

![修改库成员——流程图](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/%E4%BF%AE%E6%94%B9%E5%BA%93%E6%88%90%E5%91%98%E2%80%94%E2%80%94%E6%B5%81%E7%A8%8B%E5%9B%BE.png)



#### 3.3 流程描述

* 判断库成员是否存在（根据配置mysql.member.on决定查询MYSQL还是云数据库），若不存在（不存在或状态为待删除-1），则返回失败，库成员不存在；

* 存在记录，则更新MEMBER表

* 根据配置mysql.member.on决定是否更新云数据库，更新云数据库数据；

### 4. 删除库成员

```java
// 根据成员ID删除对应的库成员信息，包括图片及特征；删除不存在库成员返回成功。
DELETE  /processing/face/repository/member/[memberId]
    
DELETE  /processing/face/repository/member/12345678 HTTP/1.1
{
    "syncToCluster":false
    //是否将库成员信息同步到智能计算一体机聚类业务的数据库中，默认为false，表示不将库成员同步到智能计算一体机聚类业务的数据库。
}
HTTP/1.1 200
```



#### 4.1 时序图

![image-20240806145658759](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20240806145658759.png)

#### 4.2 流程图

[删除库成员.pdf](C:\Users\485322\Documents\库管理\Visio图\删除库成员——流程图.pdf)

![删除库成员——流程图](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/%E5%88%A0%E9%99%A4%E5%BA%93%E6%88%90%E5%91%98%E2%80%94%E2%80%94%E6%B5%81%E7%A8%8B%E5%9B%BE.png)



#### 4.3 流程描述

1. 接收到Saas服务下发删除库成员请求。

2. **服务状态检查**：检测mysql以及mq状态，如异常返回异常

3. **参数校验**

4. **查询持久化数据**:如果 isMysqlMenberOn开启，查询mysql库成员记录，关闭查询云库库成员记录。获取库信息。

5. **获取资源信息:** 根据库库ID信息，获取对应资源信息。

6.  **删除持久化数据**：如果 isMysqlMenberOn开启，删除mysql库成员记录，关闭则删除云库库成员记录。获取库信息。

7. **删除Feature特征**：请求feature删除特征，删除失败记录FEATURE_TO_PF表，后台线程处理。

8.  **删除算子特征：**向算子广播删除特征

9.  **返回结果。**



### 5. 删除库成员特征

```java
// 根据成员ID以及库id删除对应的库成员信息，删除不存在库成员返回成功。只删除特征记录，不操作数据库。
DELETE  /processing/face/repository/member/v3
{
    "memberId":"xxxxxx", // 必填
    "repositoryId":"xxxxxx"， // 必填
    "syncToCluster":false  //是否将库成员信息同步到智能计算一体机聚类业务的数据库中，默认为false，表示不将库成员同步到智能计算一体机聚类业务的数据库。
}  
HTTP/1.1 200
```



#### 5.1 时序图

![image-20240806150741634](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20240806150741634.png)

#### 5.2 流程描述

1. 接收到Saas服务下发删除库成员请求。

2.  **服务状态检查**：检测mysql以及mq状态，如异常返回异常

3. **参数校验**

4.  **查询持久化数据**:查询mysql库成员记录，关闭查询云库库成员记录。获取库信息。根据库库ID信息，获取对应资源信息。

5. **删除持久化数据**：删除mysql库成员记录 

6. **删除Feature特征**：请求feature删除特征，删除失败记录FEATURE_TO_PF表，后台线程处理。

7.  **删除算子特征：**向算子广播删除特征

8. **返回结果。**

### 6. 查看库成员

```java
// 根据库成员ID查看该成员消息信息。
GET  /processing/face/repository/member/[memberId]
HTTP/1.1 200
{
    "repositoryId" : "12345678", 
    "idType" : 111,
    "identificationId" : "432524198710140065",
    "name" : "小王",
    "englishName" : "xiaowang",
    "nationalityCode" : "12",
    "validityStart" : "2018-04-13",
    "validityEnd" : "2028-04-13",
    "region" : 12222,
    "nation" :   1,
    "birthday" : "1985-10-17",
    "gender" : 1,
    "province" : "xx",
    "city" : "xx",
    "tel" : "xxxx",
    "address" : "xx",
    "memo" : "xxx",
    "ext1" : "xx",
    "ext2" : "xxx",
    "ext3" : "xxx",
    "pictureUrl" : "xxxxxxx" ,
    "faceImageUrl" : "xxxxxxx" ,
    "faceImageId" : "xxxxxxx"
}
```



#### 6.1 时序图

![image-20240806150848375](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20240806150848375.png)



#### 6.2 流程图

![查看库成员——流程图](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/%E6%9F%A5%E7%9C%8B%E5%BA%93%E6%88%90%E5%91%98%E2%80%94%E2%80%94%E6%B5%81%E7%A8%8B%E5%9B%BE.png)





## 三、通道分析

### 1. 添加人脸通道分析

```json
// 添加一路图片分析或者视频分析，当该通道人脸分析已添加，则直接返回对应的分析任务ID。
POST  /processing/face/analysis
{
    "channelId" : "12345678",
    "type": 1,              //分析类型，1，表示分析图片通道; 0 表示分析视频通道，默认为0
    "userChannelCode" : "xxxxx",
    "priority": 2,
    "regionId" : "xxxxxx",
    "url" : "xxxxxxx",
    "memo": "我的通道",       //备注信息，最长128字符
}

{
    "id" : "xxxxxxx"
}
```



#### 1.1 时序图

[添加人脸分析-时序图.pdf](C:\Users\485322\Downloads\添加人脸分析-时序图.pdf)

![添加人脸分析-时序图.drawio](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/%E6%B7%BB%E5%8A%A0%E4%BA%BA%E8%84%B8%E5%88%86%E6%9E%90-%E6%97%B6%E5%BA%8F%E5%9B%BE.drawio.png)

#### 1.2 流程图

[添加人脸分析.pdf](C:\Users\485322\Downloads\添加人脸分析-流程图.pdf)



<img src="%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/%E6%B7%BB%E5%8A%A0%E4%BA%BA%E8%84%B8%E5%88%86%E6%9E%90-%E6%B5%81%E7%A8%8B%E5%9B%BE.drawio.png" alt="添加人脸分析-流程图.drawio" style="zoom: 200%;" />

#### 1.3 流程描述

1. 参数校验，可以选择实时图片流类型与实时视频流类型

2.  组装参数 dataSource需要转化，0,1 转化为2,5 标识视频流与图片流

3.  判断此记录是否已经存在，若存在DataSource类型不同的任务也返回失败

4.  如果数据库中存在已经删除的任务 状态为-5，则校验记录中的库是否存在(为了下发同一个通道任务，复用以前的库特征)

5.  如果不存在，则创建新的抓拍库，且覆盖老的记录中的库Id

6. 如果数据库中不存在此任务，直接创建抓拍库

7.  请求ResourceManager，获取对应类型的算子

8. 写路由消息到Ex

9. 持久化记录到sql channelAnalyse表,如果是复用的状态为-5的，则更新

10.  如果是视频流，需要请求算子，开启任务

11. 更新sql channelAnalyse 视频流返回remoteTaskId

12. 视频流则组装消息发mq,用于数据治理

13.  将<用户,库Id> <channelId,库Id> 存内存中

#####  任务状态上报逻辑

实时视频流算子会上报进度

1.  上报的状态不是running 与error 则直接return

2. Sql 更新channelAnalysis 表的状态或者报错信息

3. 发布一个状态变更事件

### 2. 删除人脸通道分析

```json
// 根据人脸分析任务id删除对应人脸分析；若任务id不存在，则返回删除成功。
DELETE  /processing/face/analysis/[taskId]?force=false
// force:类型bool，是否强制删除通道分析，默认是false（不强制）。如果是true（强制删除），则会先删除这个分析对应的布控和一人一档，在删除通道分析。当通道分析在前端智能上时，不能强制删除，智能服务返回删除失败。
```



#### 2.1 时序图

[删除人脸分析-时序图](C:\Users\485322\Downloads\删除人脸分析-时序图.pdf)

![删除人脸分析-时序图.drawio](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/%E5%88%A0%E9%99%A4%E4%BA%BA%E8%84%B8%E5%88%86%E6%9E%90-%E6%97%B6%E5%BA%8F%E5%9B%BE.drawio.png)

#### 2.2 流程图

[删除人脸分析](C:\Users\485322\Downloads\删除人脸分析-流程图.pdf)

![删除人脸分析-流程图.drawio](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/%E5%88%A0%E9%99%A4%E4%BA%BA%E8%84%B8%E5%88%86%E6%9E%90-%E6%B5%81%E7%A8%8B%E5%9B%BE.drawio.png)

#### 2.3 流程描述

1.  参数校验

2. 查询记录是否已不存在，或者已是删除状态，若是则直接返回

3.  删除路由

4. 如果是视频流，需要请求RM得到算子，然后请求close任务

5.  逻辑删除通道分析记录

6. 发布状态变更事件

7. 注意，内存<用户,库Id> <channelId,库Id>没有删除

### 3. 查看人脸通道分析

```json
// 分页获取人脸分析任务
POST  /processing/face/analysis/info?args
// args为参数列表，以key=value的形式标识，多个参数之间使用&连接。
// start:类型int。选填项，从第几个结果开始返回,最小值为1，不填默认为1。
// limit:类型int。选填项，返回至多多少结果，最大值为1024，不填默认为512。
POST  /processing/face/analysis/info?start=1&limit=10
Header
{
    "taskIds":[1,2],
    "channelIds":["通道1","通道2"]
}

Header
{
    "totalCount" : 2,
    "results": [
    {
        "id": "1",
        "channelId": "通道1",
        "priority": 1,
        "repositoryId" : "123",
        "regionId" : "abcs1ghy",
        "type": 0,
        "url": "xxxxxxx",
        "enabled": 1,
        "memo": "xxxxxxx",
        "status": 1
    },
    {
        "id": "1",
        "channelId": "通道1",
        "priority": 1,
        "repositoryId" : "123",
        "regionId" : "abcs1ghy",
        "type": 0,
        "url": "xxxxxxx",
        "enabled": 1,
        "memo": "xxxxxxx",
        "status": 1
    }]
}
```



#### 3.1 时序图

仅查数据库

#### 3.2 流程图

仅查数据库

#### 3.3 流程描述

1. 参数校验

2. 查询sql,得到通道分析记录

3. 参数转换一下dataSource

### 4. 检测分析

```json
// 检测分析上传的图片是否存在人脸，并返回人脸坐标，特征值，属性，坐标为绝对坐标。
POST /processing/face/analysis/detectAnalysis
{
    "pictureData" : "xxxxxxx", // 图片数据，以base64编码。和pictureUrl必须至少存在一个。如果pictureUrl存在，则优先取pictureUrl。
    "pictureUrl" : "http://xxxxxx", // 图片url。和pictureData必须至少存在一个。如果pictureUrl存在，则优先取pictureUrl。
    "processType" : [1,2,3] // 处理类型，1 提取特征值; 2 提取属性; 3 检测(返回人脸坐标)。该参数至少要有一个值。
}

{
    "results": [
    {
        "points": [{
            "x": 141,
            "y": 196
        }],
        "feature": "xxx",
            "algorithmVersion": "1001001002003",
        "attribute": {
            "angle":[1,1,1,1,1],
            "picPixle":[50,20],
            "facePixle":[30,20],
            "eye":1,
            "mouth":0,
            "emotion":1,
            "attractive":100,
            "age": 27,
            "gender": 1,
            "clarity":80,
            "beard": 0,
            "fringe": 0,
            "mask": 0,
            "glassesType": 1,
            "qeScore": 60
        },
        "faceAttr": "{
            "angle":[1,1,1,1,1],
            "picPixle":[50,20],
            "facePixle":[30,20],
            "eye":1,
            "mouth":0,
            "emotion":1,
            "attractive":100,
            "age": 27,
            "gender": 1,
            "clarity":80,
            "beard": 0,
            "fringe": 0,
            "mask": 0,
            "glassesType": 1,
            "qeScore": 60
        }"
    }]
}
```



#### 4.1 时序图

仅请求算子

#### 4.2 流程图

仅请求算子

#### 4.3 流程描述

1. 请求RM 得到算子信息

2. 请求算子进行检测分析

3.  返回值处理

### 5. 批量检测 云睿

```json
// 批量检测分析上传的图片是否存在人脸，并返回特征值
POST /processing/face/analysis/batch/detectAnalysisV2
{
    "pictureDatas" : [
        {
            "requestId":"", // 必填。
            "data":"xxx", // 图片base64。可选
            "url":"xxx" // 图片url。可选 优先级url > data
        }
    ],
    "processType" : [1,2], // 1 提取特征值;2提取属性
    “algorithmVersions”:["xxx1","xxx2"],
    "networkLabel":"1" // 网络标签，由云睿指定使用哪个网络下的分析算子
}

{
    "results": [
    {
        "requestId": "1234556",
        "isSuccess":true,
        "featureList": [
            {
                "feature": "xxx",
                "algorithmVersion":"1003001009001"
            },
            {
                "feature": "xxx",
                "algorithmVersion":"1003001006001"
            }
        ],
        "faceAttr": "{
            "picType"：1,
            "angle":[1,1,1,1,1],
            "picPixle":[50,20],
            "facePixle":[30,20],
            "eye":1,
            "mouth":0,
            "emotion":1,
            "attractive":100,
            "age": 27,
            "gender": 1,
            "clarity":80,
            "beard": 0,
            "fringe": 0,
            "mask": 0,
            "glassesType": 1,
            "qeScore": 60
        }"
    }]
}
```



#### 5.1 时序图

仅请求算子

#### 5.2 流程图

仅请求算子

#### 5.3 流程描述

1. 请求RM 得到算子信息，要支持按照networkLabel查询

2.  请求算子进行检测分析

3. 返回值处理

## 四、录像分析

### 1. 创建录像分析

```json
// 中心录像、离线视频文件进行智能分析
POST /processing/face/video
{
    "regoinId" : "abcs1ghy", // 分析通道所属paas域id。选填项。当regoinId为空，则优先选取中心域，再选择边缘域，若整套系统中无域id概念时，则任意选取一个算子； 当regionId非空，但无对应的算力资源，则返回添加失败
    "jobId" : "xxxxx", // 任务Id。必填项。
    "channelId" : "xxxxx", // 通道Id。必填项。中心录像，为真实的视频通道编码；离线视频文件，为虚拟的Id。
    "userChannelCode" : "xxxxx", // SaaS用户自定义编码。可选项。
    "priority": 2, // 任务优先级，可选，默认值为2；
    "dataSource" : 3, // 数据来源，必填项。3	视频录像 4	视频文件 99	其它
    "analysisRules":"xxxxx", // 分析规则。可选项。算子暂不支持
    "fileInfos":[
    {
        "fileUrl" : "rtsp://xxxxxxxx", // MGW服务的RTSP地址。必填项。
        "startTime" : "yyyyMMddTHHmmssZ", // 视频的开始时间。选填。当dataSource为3时有效；
        "endTime" : "yyyyMMddTHHmmssZ", // 视频的结束时间。 选填。当dataSource为3时有效；
        "fileSize" : 42351343 // 文件长度，单位为字节。选填。当dataSource为4时有效；
    }],
    "memo" : "xxxxxxx"
}

{
    "id" : "xxxxxxx" // 生成的录像分析任务id。
}
```



#### 1.1 时序图

![添加录像分析任务-时序图.drawio](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/%E6%B7%BB%E5%8A%A0%E5%BD%95%E5%83%8F%E5%88%86%E6%9E%90%E4%BB%BB%E5%8A%A1-%E6%97%B6%E5%BA%8F%E5%9B%BE.drawio.png)



#### 1.2 流程图

[添加录像分析](C:\Users\485322\Downloads\添加录像分析任务-流程图.pdf)

<img src="%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/%E6%B7%BB%E5%8A%A0%E5%BD%95%E5%83%8F%E5%88%86%E6%9E%90%E4%BB%BB%E5%8A%A1-%E6%B5%81%E7%A8%8B%E5%9B%BE.drawio.png" alt="添加录像分析任务-流程图.drawio" style="zoom:150%;" />



#### 1.3 流程描述

1. 参数校验 DataSource 3为视频录像，4为视频文件

2.  流控 注意查询Task表中人脸与结构化，running与waiting的任务

3. 离线参数组装

4. 创建库。 如果创建库失败，则将库Id设置为-1,直接返回异常

5. 写sql Job表，人脸录像分析类型为3

6. 写sql FileAnalysis表

7. 添加路由到Ex

8. 写sql Task表，是批量写，task是一个list.

9. 将task 一个一个添加到优先级队列
10.  将<用户,库Id> <channelId,库Id> 存内存中
     

### 2. 删除录像分析

```json
// 根据录像分析任务ID删除对应录像任务分析；若该任务ID不存在，则返回成功；若该录像分析正在运行之中，则先停止，再删除（录像分析结果存在云数据库中，故暂不删除）。
DELETE  /processing/face/video/[id]
```



#### 2.1 时序图

![删除录像分析任务-时序图](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/%E5%88%A0%E9%99%A4%E5%BD%95%E5%83%8F%E5%88%86%E6%9E%90%E4%BB%BB%E5%8A%A1-%E6%97%B6%E5%BA%8F%E5%9B%BE.png)

#### 2.2 流程图

[删除录像分析任务-流程图](C:\Users\485322\Downloads\删除录像分析任务-流程图.pdf)

![删除录像分析任务-流程图.drawio](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/%E5%88%A0%E9%99%A4%E5%BD%95%E5%83%8F%E5%88%86%E6%9E%90%E4%BB%BB%E5%8A%A1-%E6%B5%81%E7%A8%8B%E5%9B%BE.drawio.png)

#### 2.3 流程描述

1.  根据参数录像分析任务Id查询sql FileAnalysis表，若没有记录则直接返回

2. 删除路由

3.  **更新Task表，状态置为-5，标识逻辑删除** 

4.  组装生成关闭任务线程，放入优先级队列执行

5. 删除job表与FileAnalysis表

6. 删除内存中记录的<用户,库Id> <channelId,库Id>



### 3. 启停录像分析

```json
// 根据录像分析任务ID启停对应录像任务分析；若该任务ID不存在，则返回失败，该任务不存在。
PUT  /processing/face/video/[id]
{
    "operation" : 0   // 0	表示停止 1	表示启动
}
```



#### 3.1 时序图

![启停录像分析任务-时序图](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/%E5%90%AF%E5%81%9C%E5%BD%95%E5%83%8F%E5%88%86%E6%9E%90%E4%BB%BB%E5%8A%A1-%E6%97%B6%E5%BA%8F%E5%9B%BE.png)

#### 3.2 流程图

[启停录像分析任务-流程图](C:\Users\485322\Downloads\启停录像分析任务-流程图.pdf)

![启停录像分析任务-流程图.drawio](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/%E5%90%AF%E5%81%9C%E5%BD%95%E5%83%8F%E5%88%86%E6%9E%90%E4%BB%BB%E5%8A%A1-%E6%B5%81%E7%A8%8B%E5%9B%BE.drawio.png)

#### 3.3 流程描述

1. 根据参数录像分析任务Id查询sql FileAnalysis表，若没有记录则直接返回

2. 一个录像分析任务对应很多的Task任务，每个Task都有status

3.  根据所有task的状态，来获取一个job的状态。 例如只要有task状态是error或者abnornal,整个job状态就是abnormal; 然后只要有running,整个job状态就是running

4. 如果job状态是已完成，直接返回，不能启停已经完成的任务

5. 修改FileAnalysis表的Enable状态

6. 若是开启，就下发路由；若是关闭，就删除路由、

7. 若是开启，Task状态置为waitting;若是关闭，状态置为pause,更新sql Task表

8. 组成视频流任务，下发到优先级队列中

9. 队列中分别执行，开启或者关闭的任务

### 4. 查看录像分析





## 五、布控管理

将通道与布控库（黑名单库、白名单库）关联，按照预先设定的阈值，当通道过人与被布控的库中的某个或多个库成员相似度>=阈值，则触发告警。

#### 1. 添加人脸布控管理

```json
// 将一个人像库与一路通道进行关联，该通道的所有抓拍过人与布控人像库进行比对，查看相似性是否高于设定阈值；若通道不存在，则返回布控失败。
POST  /processing/face/surveillance
{
    "channelId": "12345678", // 通道id。必填项。
    "repositoryId": "1", // 布控库id。必填项。
    "threshold": 0.8, // 报警分数线，取值范围0~1，选填，默认值为0.8，精确到小数点后4位。
    "topN": 1, // 布控最大返回的相似度人员，可选项，默认值为1，范围1-10。
    "memo": "xxxxxxxx"
}
{
    "id" : "xxxxxxx" // 布控id。
}
```



##### 1.1. 时序图

![img](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/Tue,%2006%20Aug%202024%20171050.png)

##### 1.2. 流程图

[添加人脸布控管理-流程图](C:\Users\485322\Downloads\添加人脸布控管理-流程图.pdf)

![添加人脸布控管理-流程图.drawio](%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/%E6%B7%BB%E5%8A%A0%E4%BA%BA%E8%84%B8%E5%B8%83%E6%8E%A7%E7%AE%A1%E7%90%86-%E6%B5%81%E7%A8%8B%E5%9B%BE.drawio.png)

##### 1.3. 流程描述

1. SaaS下发添加布控任务请求；

2. 参数校验，若参数校验不通过，返回异常；

3. 判断库是否存在；

4. 若库不存在，返回异常；

5. 若库存在，判断库是否为静态库；

6. 若为静态库，返回异常；

7. 若不为静态库，根据库id与通道id是查询是否已存在布控；

8. 若布控已存在，则直接返回布控id；

9. 若不存在，将布控记录写入SURVEILLANCE表；

10. Rpc调用Excutor添加布控规则；

11. 若Rpc调用失败，则回滚SURVEILLANCE表记录，若Rpc调用成功，则返回布控id。



